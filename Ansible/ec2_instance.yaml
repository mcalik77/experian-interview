---
host: localhost
become: yes
become_user: root
tasks:

  - name: Upgrade all packages
    yum:
      name: '*'
      state: latest

  - name: Install following packages
    yum:
      name: "{{ packages }}"
      vars:
        packages:
          - tomcat
          - python3
          - python3-pip
          - docker-engine
          - git
          - curl

  - name: Set the proxy
    environment:
      http_proxy: https://usproxy-server.mycompany.aws:8443
    when: curl http://169.254.169.254/latest/meta-data/placement/availability-zone == 'us-west-2a' or curl http://169.254.169.254/latest/meta-data/placement/availability-zone == 'us-west-2b'

  - name: Copy of the local remote file
    copy:
      src: /mycompany-services.tar.gz
      dest: /tmp

  - name: Extract mycompany-services.tar.gz into /data
    unarchive:
      src: /tmp
      dest: /data

  - name: Start service docker and tomcat, if not started
    service:
      name: docker
      state: started

    service:
      name: tomcat
      state: started
